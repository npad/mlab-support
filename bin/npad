#!/bin/sh

# This script is adapted from the one generated by configure.py

DIAG_SERVER_DAEMON=/home/iupui_npad/npad-dist/DiagServer.py
PIDFILE=/home/iupui_npad/VAR/run/npad.pid
LOGDIR=/home/iupui_npad/VAR/logs
LOGFILE=$LOGDIR/diag_server_log
DIAG_SERVER_OPTS="-d -u $USER -p $PIDFILE -l $LOGFILE"
export LD_LIBRARY_PATH=/usr/local/lib

start() {
	if [ -f $PIDFILE ]; then
		pid=`cat $PIDFILE`
		if [ "`ps -p $pid -o comm=`" = "DiagServer.py" ]; then
			echo "NPAD server already running, not starting."
			exit 1
		fi
	fi
	# Manage logs first
	if [ -s $LOGFILE ]; then
	    mv $LOGFILE.3 $LOGFILE.4
	    mv $LOGFILE.2 $LOGFILE.3
	    mv $LOGFILE.1 $LOGFILE.2
	    mv $LOGFILE $LOGFILE.1
	else
	    mkdir -p $LOGDIR
	fi
	${DIAG_SERVER_DAEMON} ${DIAG_SERVER_OPTS}
	echo "NPAD server started."
}

stop() {
	if [ -f $PIDFILE ]; then
		pid=`cat $PIDFILE`
		if [ "`ps -p $pid -o comm=`" = "DiagServer.py" ]; then
			kill $pid
			rm $PIDFILE
			exit 0
		fi
	fi
	exit 1
}

case "$1" in
	start)
		start
		;;
	stop)
		stop
		;;
	restart)
		start
		stop
		;;
	*)
		echo "Usage: $0 {start|stop|restart}"
		exit 1
		;;
esac

exit 0
